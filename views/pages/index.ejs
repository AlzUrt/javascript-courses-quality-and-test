<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<style>
    .game-over-message {
        font-size: 3em;
        font-weight: bold;
        text-align: center;
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
        text-transform: uppercase;
    }
    .victory-message {
        background-color: #4CAF50;
        color: white;
    }
    .defeat-message {
        background-color: #F44336;
        color: white;
    }
</style>
<body class="container" data-game-over="<%= isGameOver %>">

<main>

    <h1>❓</span> Le jeu du pendu ❓</h1>
    <p>Essayer de deviner le mot !</p>

    <h2>Score: <span id="score"><%= score %></span></h2>

    <% if (!isGameOver) { %>
        <form action="/" method="post">
            <fieldset class="uk-fieldset">

                <legend class="uk-legend">Nombre d'essai restant : <%= numberOfTries %></legend>

                <div class="uk-margin">
                    <input class="uk-input" type="text" name="word" placeholder="Tapez une lettre" maxlength="1" pattern="[a-zA-Z]" required>                </div>

                <div class="uk-margin">
                    <button class="uk-input uk-button-danger uk-form-width-medium" type="submit" name="reset" value="true">Reset</button>
                    <button class="uk-input uk-button-secondary uk-form-width-medium" type="submit" value="form-success">Tester</button>
                </div>

            </fieldset>
        </form>
        
        <% if (guessedLetters) { %>
            <p>Lettres essayées : <%= guessedLetters %></p>
        <% } %>
        <% } else if (isGameWon && !isScoreSubmitted) { %>
            <p>Félicitations ! Vous avez gagné. Entrez votre pseudo pour enregistrer votre score.</p>
            <form action="/" method="post">
                <input class="uk-input" type="text" name="pseudo" placeholder="Entrez votre pseudo" required>
                <button class="uk-button uk-button-primary" type="submit">Enregistrer le score</button>
            </form>
            <!-- Nouveau bouton de partage Twitter -->
            <button id="twitterShareBtn" class="uk-button uk-button-secondary" onclick="shareOnTwitter()">Partager sur Twitter</button>
        <% } else if (isGameWon && isScoreSubmitted) { %>
            <p>Votre score a été enregistré. Merci d'avoir joué !</p>
            <form action="/" method="post">
                <button class="uk-input uk-button-danger uk-form-width-medium" type="submit" name="reset" value="true">Nouvelle partie</button>
            </form>
            <!-- Nouveau bouton de partage Twitter -->
            <button id="twitterShareBtn" class="uk-button uk-button-secondary" onclick="shareOnTwitter()">Partager sur Twitter</button>
    <% } else { %>
        <p>Le jeu est terminé. Appuyez sur Reset pour recommencer.</p>
        <form action="/" method="post">
            <button class="uk-input uk-button-danger uk-form-width-medium" type="submit" name="reset" value="true">Reset</button>
        </form>
    <% } %>

    <% if (isGameOver) { %>
        <% if (isGameWon) { %>
            <div class="game-over-message victory-message">
                Victoire !
            </div>
        <% } else { %>
            <div class="game-over-message defeat-message">
                Défaite !
            </div>
        <% } %>
    <% } %>

    <% if (game) { %>
        <h3>Votre mot : <%= game %></h3>
    <% } %>

    <% if (isGameOver) { %>
        <h3>Le mot était : <%= word %></h3>
    <% } %>

    <h3>Meilleurs scores :</h3>
    <ul>
        <% topScores.forEach(score => { %>
            <li><%= score.pseudo %> : <%= score.score %> (mot : <%= score.word %>)</li>
        <% }); %>
    </ul>

</main>

<script>
    (function() {
        var isGameOver = document.body.dataset.gameOver === 'true';

        function updateScore() {
            if (!isGameOver) {
                $.get('/score', function(data) {
                    $('#score').text(data.score);
                });
            }
        }

        // Update score every second
        var scoreInterval = setInterval(updateScore, 1000);

        // Stop updating score if game is over
        if (isGameOver) {
            clearInterval(scoreInterval);
        }
    })();

    function shareOnTwitter() {
        var tweetText = "J'ai gagné au jeu du Pendu avec un score de " + document.getElementById('score').innerText  + " ! Pouvez-vous faire mieux ?";
        var tweetUrl = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(tweetText);
        window.open(tweetUrl, '_blank');
    }

    // Fonction pour valider la saisie
    function validateInput(event) {
        var char = String.fromCharCode(event.which);
        if (!/[a-zA-Z]/.test(char)) {
            event.preventDefault();
            return false;
        }
    }

    // Fonction pour convertir en majuscules
    function toUpperCase(event) {
        event.target.value = event.target.value.toUpperCase();
    }

    // Attacher les événements au champ de saisie
    document.addEventListener('DOMContentLoaded', function() {
        var input = document.querySelector('input[name="word"]');
        if (input) {
            input.addEventListener('keypress', validateInput);
            input.addEventListener('input', toUpperCase);
        }
    });
</script>

</body>
</html>